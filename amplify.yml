version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            # Enable corepack and use pnpm with strict integrity check
            - corepack enable
            - corepack prepare pnpm@latest --activate
            - pnpm install --frozen-lockfile --prefer-offline

        build:
          commands:
            # Ensure clean build and environment safety
            - echo "Starting Next.js production build..."
            - pnpm run lint || echo "Lint warnings only, continuing build..."
            - pnpm run build

      artifacts:
        # Next.js output directory
        baseDirectory: .next
        files:
          - '**/*'

      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*

    environment:
      # Production optimizations
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: 1
      NEXT_PUBLIC_SITE_URL: https://paravidyafoundation.com
      # Helps ensure consistent environment builds
      CI: true

    customHeaders:
      # âœ… SEO & security headers
      - pattern: '**/*'
        headers:
          - key: Strict-Transport-Security
            value: max-age=63072000; includeSubDomains; preload
          - key: X-Frame-Options
            value: DENY
          - key: X-Content-Type-Options
            value: nosniff
          - key: Referrer-Policy
            value: strict-origin-when-cross-origin
          - key: Permissions-Policy
            value: camera=(), microphone=(), geolocation=()
          - key: Cache-Control
            value: public, max-age=31536000, immutable
          - key: X-XSS-Protection
            value: 1; mode=block
          - key: Content-Security-Policy
            value: default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval';
